const fs = require('fs');
const path = require('path');

const dataDir = path.join(__dirname, '../data/tech-stack-data');

function generateVersions() {
    if (!fs.existsSync(dataDir)) {
        console.error(`Directory not found: ${dataDir}`);
        process.exit(1);
    }

    const files = fs.readdirSync(dataDir);
    const versions = files
        .filter(file => file.endsWith('.json') && file !== 'versions.json')
        .map(file => file.replace('.json', ''))
        .sort((a, b) => {
            const parse = (v) => v.split('-').map(Number);
            const av = parse(a);
            const bv = parse(b);
            for (let i = 0; i < Math.max(av.length, bv.length); i++) {
                const aNum = av[i] || 0;
                const bNum = bv[i] || 0;
                if (aNum > bNum) return -1;
                if (aNum < bNum) return 1;
            }
            return 0;
        });

    // Generate versionDataMap.js with both imports and version list
    const imports = versions.map(v => {
        const varName = 'data_' + v.replace(/-/g, '_');
        return `import ${varName} from './${v}.json';`;
    }).join('\n');

    const mapEntries = versions.map(v => {
        const varName = 'data_' + v.replace(/-/g, '_');
        return `  '${v}': ${varName},`;
    }).join('\n');

    const versionsArray = versions.map(v => `  '${v}',`).join('\n');

    const mapContent = `// Auto-generated file - do not edit manually
// This file is generated by scripts/gen-tech-stack-versions.js

${imports}

export const versions = [
${versionsArray}
];

export const versionDataMap = {
${mapEntries}
};
`;

    const mapPath = path.join(dataDir, 'versionDataMap.js');
    fs.writeFileSync(mapPath, mapContent);
    console.log(`Generated ${mapPath} with ${versions.length} versions.`);
}

generateVersions();
